---

- hosts: localhost
  connection: local
  gather_facts: False

  vars:
    keypair: my-key325
    region: us-east-1
    instance_type: t2.micro
    ami: ami-09d56f8956ab235b3 # https://cloud-images.ubuntu.com/locator/ec2/
    id: "web-app"

  tasks:

    # - name: Get instances facts
    #   ec2_instance_facts:
    #     aws_access_key: "{{ec2_access_key}}"
    #     aws_secret_key: "{{ec2_secret_key}}"
    #     region: "{{ region }}"
    #   register: result



    - name: Create an ec2 instance
      ec2:
        aws_access_key: "{{ec2_access_key}}"
        aws_secret_key: "{{ec2_secret_key}}"
        key_name: "{{ keypair }}"
        group: MySecurityGroup325  # security group name
        instance_type: "{{ instance_type }}"
        image: "{{ ami }}"
        wait: true
        region: "{{ region }}"
        count: 1  # default
        count_tag:
          Name: Demo
        instance_tags:
          Name: Demo
      register: ec2

    - name: Instances ID
      debug:
        msg: "ID: {{ item.instance_id }} - State: {{ item.state.name }} - Public DNS: {{ item.public_dns_name }}"
      loop: "{{ ec2.instances }}"
